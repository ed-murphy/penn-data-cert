---
title: 'Homework Assignment #4'

author: "Ed Murphy"

date: "February 19, 2024"
output:
  html_document:
    df_print: paged
  word_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE) 
library(tidyverse) 
library(nycflights13)
options(tibble.width = Inf)
```

## Question #1

Question #1 from the homework, which is question 13.5.1.5 from the textbook, asks:

What do these lines of code tell you?

```{r code1, eval=FALSE}
anti_join(flights, airports, by = c("dest" = "faa"))
anti_join(airports, flights, by = c("faa" = "dest"))
```


Let's take a look at the first 10 rows of the table that are generated by that first line of code above.


```{r antijoin1, echo=FALSE}
# run the code from the question
anti_join(flights, airports, by = c("dest" = "faa")) %>%
  head(10)
```


That code keeps the observations in flights for which the "dest" variable doesn't have a match to the "faa" variable in airports. In other words, we're getting a list of 2013 flights from NYC that flew to a place that does not have an FAA code. What does it mean to have an airport without an FAA code? Let's examine that.


```{r which_dest, echo=FALSE}
# let's see what's left after running the anti join
anti_join(flights, airports, by = c("dest" = "faa")) %>%
  count(Destination = dest) %>%
  rename(
    "Number of Flights" = n
  )
```


We see that there are four destinations from flights without an FAA code in airports. Those destinations are in Puerto Rico and St. Thomas. So something is going on with how "domestic" is defined in different datasets. The flights data uses a definition of domestic that includes Puerto Rico and St. Thomas, but the airports data shows that the FAA does not consider those places to be "domestic" in the sense that they don't assign them standard FAA codes.


Now, let's take a look at the first 10 rows of the table that is generated by the second line of code from above.

```{r antijoin2, echo=FALSE}
# run the code from the question
anti_join(airports, flights, by = c("faa" = "dest")) %>%
  head(10)
```

This line of code keeps observations in airports for which the "faa" value does not have a match in the "dest" value in flights. So we're left with the airports that are never destinations for NYC flights in 2013. There are alot of these, which means that while you could have flown from NYC to many different places in 2013, you still could not fly to `r nrow(anti_join(airports, flights, by = c("faa" = "dest")))` of the FAA-coded airports.


## Question #2

The day with the longest average total delay was March 8th. That day had cold temperatures, precipitation, low visibility, and significant average wind speeds. It is not surprising that such a day would have major delays. Another factor is likely that a day with such "wintry" conditions fell in March. If such a day fell in January or February, perhaps airport staff is ready to handle that type of weather. On March 8th, we typically wouldn't be expecting snow (at least in the NYC area), so the procedures for getting planes off the ground in snowy weather could have been more challengin due to the surprise.

```{r delay, echo=FALSE, message=FALSE}

# creating not_canceled because canceled flights fall entirely outside of the universe
# of "delayed" flights
not_canceled <- flights %>%
  filter(!is.na(dep_delay), !is.na(arr_delay))

# rank days by average delay and merge weather on
not_canceled %>%
  group_by(month, day) %>%
  summarize(
    avg_arr_delay = mean(arr_delay),
    avg_dep_delay = mean(dep_delay)
  ) %>%
  mutate(
    avg_tot_delay = avg_arr_delay + avg_dep_delay
  ) %>%
  arrange(desc(avg_tot_delay)) %>%
  left_join(
    weather %>%
      group_by(month, day) %>%
      summarize(
        temp_NYC = mean(temp),
        visib_NYC = mean(visib),
        precip_NYC = mean(precip),
        wind_speed_NYC = mean(wind_speed)
      ),
    by = c("month", "day")
  ) %>%
  rename(
    "Month" = month,
    "Day" = day,
    "Average Total Delay (mis)" = avg_tot_delay,
    "Average Temperature (degrees F)" = temp_NYC,
    "Visibility (miles)" = visib_NYC,
    "Precipitation (inches)" = precip_NYC,
    "Average Wind Speed (mph)" = wind_speed_NYC
  ) %>%
  select(
    -c(avg_arr_delay, avg_dep_delay)
  )

```


## Question #3

The planes with the fastest average speeds are large planes with turbo jet/fan engines from prominent manufacturers. They also tend to go on very long trips. In addition, the top 4 fastest planes only went on 1 trip that left from NYC in 2013, and in each case it happened to be a very long one. The others in the top 10 exclusively fly to Hawaii.

So what we're looking at here is more the fact that the fastest planes in the data are ones that fly cross country or to Hawaii. Presumably long distances allow for the planes to sit at high cruising speeds for a high proportion of their flights. That is not surprising.


```{r speed, echo=FALSE}
flights %>%
  mutate(
    flight_avg_speed = distance / (air_time / 60)
  ) %>%
  group_by(tailnum) %>%
  summarize(
    plane_avg_speed = mean(flight_avg_speed),
    count = n(),
    avg_trip_dist = mean(distance)
  ) %>%
  left_join(planes, by = c("tailnum")) %>%
  arrange(desc(plane_avg_speed)) %>%
  rename(
    "Tail Number" = tailnum,
    "Average Speed" = plane_avg_speed,
    "Flights in 2013" = count,
    "Average Trip Distance" = avg_trip_dist,
    "Passenger Capacity" = seats,
    "Engine Type" = engine,
    "Manufacturer" = manufacturer,
    "Year Plane Made" = year
  ) %>%
  select(-c(model, speed, type, engines))
```


## Question #4

Problem 13.4.6.3 from the textbook asks:
Is there a relationship between the age of a plane and its delays?

We see that as planes get older, they tend to have lower average delays.

```{r age_delays, echo=FALSE, message=FALSE}

not_canceled <- flights %>%
  filter(!is.na(dep_delay), !is.na(arr_delay))

not_canceled %>%
  left_join(select(planes, tailnum, plane_made = year), by = "tailnum") %>%
  mutate(
    plane_age = year - plane_made
  ) %>%
  filter(!is.na(plane_age)) %>%
  group_by(plane_age) %>%
  summarize(
    avg_dep_delay = mean(dep_delay),
    avg_arr_delay = mean(arr_delay),
    avg_total_delay = avg_dep_delay + avg_arr_delay
  ) %>%
  ggplot(mapping = aes(x = plane_age, y = avg_total_delay)) +
    geom_point() +
    geom_smooth() +
    xlab("Age of Plane") +
    ylab("Average Delay (minutes)") +
    ggtitle("Average Delay by Age of Plane") +
    theme(plot.title = element_text(hjust = 0.5))

```

But could this just be a result of how older planes are used rather than some inherent characteristic of older planes? Maybe older planes are used more sparingly on the nicest weather days of the year or for the easiest trips, and are therefore less likely to be delayed? Let's see if there is a relationship between plane age and the number of flights.



```{r age_frequency, echo=FALSE, message=FALSE}

not_canceled %>%
  left_join(select(planes, tailnum, plane_made = year), by = "tailnum") %>%
  mutate(
    plane_age = year - plane_made
  ) %>%
  filter(!is.na(plane_age)) %>%
  group_by(plane_age) %>%
  summarize(
    avg_dep_delay = mean(dep_delay),
    avg_arr_delay = mean(arr_delay),
    avg_total_delay = avg_dep_delay + avg_arr_delay,
    num_flights = n()
  ) %>%
  ggplot(mapping = aes(x = plane_age, y = num_flights)) +
    geom_point() +
    geom_smooth() +
    xlab("Age of Plane") +
    ylab("Number of Flights in 2013") +
    ggtitle("Number of Flights Leaving NYC in 2013 by Age of Plane") +
    theme(plot.title = element_text(hjust = 0.5))


```

The plot above shows that clearly, older planes are used more sparingly. OK, maybe older planes are held back on bad weather days, and therefore tend to avoid delays?


```{r age_weather, echo=FALSE, message=FALSE}

not_canceled %>%
  left_join(select(planes, tailnum, plane_made = year), by = "tailnum") %>%
  left_join(
    weather %>%
      group_by(month, day) %>%
      summarize(
        precip_day = mean(precip)
      ),
    by = c("month", "day")
  ) %>%
  mutate(
    plane_age = year - plane_made,
    precip_today = ifelse( is.na(precip_day) | precip_day <= 0, 0, 1)
  ) %>%
  filter(!is.na(plane_age)) %>%
  group_by(plane_age) %>%
  summarize(
    avg_dep_delay = mean(dep_delay),
    avg_arr_delay = mean(arr_delay),
    avg_total_delay = avg_dep_delay + avg_arr_delay,
    num_flights = n(),
    share_precip_days = mean(precip_today)
  ) %>%
  ggplot(mapping = aes(x = plane_age, y = share_precip_days)) +
    geom_point() +
    geom_smooth() +
    xlab("Age of Plane (years)") +
    ylab("Share of Days Flying with Precipitation") +
    ggtitle("Share of Days Flying with Precipitation by Age of Plane") +
    theme(plot.title = element_text(hjust = 0.5))

```

In the plot above, we can see that our "older planes get held back on days with bad weather" hypothesis is wrong. At least in terms of precipitation. But maybe older planes tend to go to familiar destinations that rarely have delays?

```{r age_dest, echo=FALSE}

not_canceled %>%
  left_join(select(planes, tailnum, plane_made = year), by = "tailnum") %>%
  mutate(
    plane_age = year - plane_made
  ) %>%
  filter(!is.na(plane_age)) %>%
  group_by(plane_age) %>%
  summarize(
    avg_dep_delay = mean(dep_delay),
    avg_arr_delay = mean(arr_delay),
    avg_total_delay = avg_dep_delay + avg_arr_delay,
    num_flights = n(),
    top_dest = max(dest)
  ) %>%
  left_join(airports, by = c("top_dest" = "faa")) %>%
  rename(
    "Most Common Destination Airport" = name,
    "Age of Plane" = plane_age,
  ) %>%
  select("Age of Plane", "Most Common Destination Airport")

```

The table shows that a lot of younger planes commonly fly to the Southeast, to airports such as Tampa and NW Arkansas. The older planes have slightly different top destinations: San Francisco, St. Louis, and Texas (George Bush). We don't have data on destination weather, but perhaps the younger planes are more frequently on routes that are impacted by rain in the Southeast.



## Appendix: All code used to make this document 

```{r ref.label=knitr::all_labels(), echo = T, eval = F}
```



